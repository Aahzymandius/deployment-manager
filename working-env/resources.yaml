imports:
- path: cluster.jinja
- path: instance.jinja

resources:
##Create static IPs    
- name: mysite-ing
  type: compute.v1.globalAddresses
  properties:
    ipVersion: IPV4
    addtressType: EXTERNAL
- name: nginx
  type: compute.v1.address
  properties:
    region: us-central1
    addressType: EXTERNAL
- name: bastionip
  type: compute.v1.addresses
  properties:
    addressType: EXTERNAL
    region: us-central1

##Create a bastion host for the project in the primary network
- name: bastion
  type: instance.jinja
  properties:
    name: bastion
    region: us-central
    zone: us-central1-f 
    networkInterfaces:
    - network: pw-network
      subnetwork: belfast
      natIP: $(ref.bastionip.address)
    tags:
    - bastion
    - web-server
    autoDelete: true
    addDisks:
    - name: bastion-1
      size: "100"
    osLogin: enabled
    metadata:
    - key: block-project-ssh-keys
      value: "true"

##Create the GKE clusters
- name: sheehy
  type: cluster.jinja
  properties:
    name: sheehy
    location: us-central1
    network: pw-network
    subnetwork: belfast
    version: latest
    vpc-native: true
    pod-cidr: pod-cidr
    service-cidr: service-cidr
    private-cluster: true
    enablePrivateEndpoint: true
    hosts:
    - host-name: bastion
      host-cidr: $(ref.bastionip.address)/32
    master-cidr: 172.16.0.0/28
    labels:
    - key: access-type
      value: private
    - key: location-type
      value: regional
    nodePools:
    - name: sheehy
      initialNodeCount: 1
      minNodeCount: 1
      maxNodeCount: 3
- name: gallagher
  type: cluster.jinja
  properties:
    name: gallagher
    location: us-central1-f
    network: pw-net
    subnetwork: london
    version: [choose 1 minor version behind current release]
    labels:
    - key: access-type
      value: public
    - key: location-type
      value: zonal
    locations:
    - us-central1-f
    - us-central1-c
    nodePools:
    - name: gallagher
      initialNodeCount: 0 
- name: connolly
  type: cluster.jinja
  properties:
    name: connolly
    location: us-central1-c
    network: pw-network
    subnetwork: dublin
    version: [2 minor version behind latest]
    vpc-native: true
    pod-cidr: pod-cidr
    service-cidr: service-cidr
    labels:
    - key: access-type
      value: public
    - key: location-type 
      value: zonal
    networkPolicy: true
    istio: true
    locations:
    - us-central1-a
    - us-central1-c
    nodePools:
    - name: connolly
      initialNodeCount: 0
      minNodeCount: 1
      maxNodeCount: 3
