imports:
- path: remove-default-vpc.jinja
- path: peering.jinja

resources:
##Remove the default VPC
- name: firewall1
  type: remove-default-vpc.jinja

##Create first network with subnets
- name: pw-net
  type: compute.v1.network
  properties: 
    autoCreateSubnetworks: false
- name: london
  type: compute.v1.subnetwork
  properties:
    network: $(ref.pw-net.selfLink) 
    ipCidrRange: 192.168.100.0/24
    region: us-central1
    secondaryIpRanges:
      - rangeName: pod-cidr
        ipCidrRange: 10.128.0.0/16
      - rangeName: service-cidr
        ipCidrRange: 10.131.0.0/24
- name: york
  type: compute.v1.subnetwork
  properties:
    network: $(ref.pw-net.selfLink)
    ipCidrRange: 192.168.102.0/24
    region: us-east1
    secondaryIpRanges:
      - rangeName: pod-cidr
        ipCidrRange: 10.129.0.0/16
      - rangeName: service-cidr
        ipCidrRange: 10.131.1.0/24
- name: brighton
  type: compute.v1.subnetwork
  properties:
    network: $(ref.pw-net.selfLink) 
    ipCidrRange: 192.168.104.0/24
    region: us-west1
    secondaryIpRanges:
      - rangeName: pod-cidr
        ipCidrRange: 10.130.0.0/16
      - rangeName: service-cidr
        ipCidrRange: 10.131.2.0/24
- name: wellington
  type: compute.v1.subnetwork
  properties:
    network: $(ref.pw-net.selfLink)
    ipCidrRange: 192.168.106.0/24
    region: us-central1
- name: allow-internal-net
  type: compute.v1.firewall
  properties:
    network: $(ref.pw-net.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges:
    - 192.168.0.0/16
    allowed:
    - IPProtocol: all

##Create priamry working network and subnets
- name: pw-network
  type: compute.v1.network
  properties: 
    autoCreateSubnetworks: false
- name: dublin
  type: compute.v1.subnetwork
  properties:
    network: $(ref.pw-network.selfLink) 
    ipCidrRange: 192.168.0.0/24
    region: us-central1
    secondaryIpRanges:
      - rangeName: pod-cidr
        ipCidrRange: 10.48.0.0/14
      - rangeName: service-cidr
        ipCidrRange: 10.242.0.0/20
- name: belfast
  type: compute.v1.subnetwork
  properties:
    network: $(ref.pw-network.selfLink)
    ipCidrRange: 192.168.1.0/24
    region: us-central1
    secondaryIpRanges:
      - rangeName: pod-cidr
        ipCidrRange: 10.0.0.0/16
      - rangeName: service-cidr-1
        ipCidrRange: 10.10.0.0/24
      - rangeName: service-cidr-2
        ipCidrRange: 10.10.1.0/24
- name: cork
  type: compute.v1.subnetwork
  properties:
    network: $(ref.pw-network.selfLink)
    region: us-east4
    ipCidrRange: 192.168.2.0/24
- name: limrick
  type: compute.v1.subnetwork
  properties:
    network: $(ref.pw-network.selfLink)
    region: us-east1
    ipCidrRange: 192.168.4.0/24
- name: sligo
  type: compute.v1.subnetwork
  properties:
    region: us-west1
    network: $(ref.pw-network.selfLink)
    ipCidrRange: 192.168.6.0/24
- name: galway
  type: compute.v1.subnetwork
  properties:
    network: $(ref.pw-network.selfLink)
    region: europe-west1
    ipCidrRange: 192.168.50.0/24
##Set some basic necessary firewall rules for the primary network
- name: allow-web-traffic
  type: compute.v1.firewall
  properties:
    network: $(ref.pw-network.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges: 
    - 0.0.0.0/0
    targetTags:
    - web-server
    allowed:
    - IPProtocol: TCP
      ports: 
      - 80
    - IPProtocol: TCP
      ports: 
      - 443
- name: bastion-ssh
  type: compute.v1.firewall
  properties:
    network: $(ref.pw-network.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges: 
    - 0.0.0.0/0
    targetTags:
    - bastion
    allowed:
    - IPProtocol: TCP
      ports: 
      - 22
- name: allow-internal
  type: compute.v1.firewall
  properties:
    network: $(ref.pw-network.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges:
    - 192.168.0.0/16
    allowed:
    - IPProtocol: all


##Peer first two networks
- name: peering
  type: peering.jinja
  properties:
    net1: pw-net
    net2: pw-network
