imports:
- path: instance.jinja
- path: cluster.jinja
- path: remove-default-vpc.jinja

resources:
- name: firewall1
  type: remove-default-vpc.jinja

##Create new VPC
- name: local-vpc
  type: compute.v1.network
  properties: 
    autoCreateSubnetworks: false
- name: primary-local
  type: compute.v1.subnetwork
  properties:
    network: $(ref.local-vpc.selfLink) 
    ipCidrRange: 192.168.0.0/24
    region: us-central1
    secondaryIpRanges:
      - rangeName: pods
        ipCidrRange: 10.0.0.0/8
      - rangeName: services1
        ipCidrRange: 172.16.0.0/20
      - rangeName: services2
        ipCidrRange: 172.16.16.0/20
      - rangeName: services3
        ipCidrRange: 172.16.32.0/20
      - rangeName: services4
        ipCidrRange: 172.16.48.0/20
- name: allow-internal
  type: compute.v1.firewall
  properties:
    network: $(ref.local-vpc.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges:
    - 192.168.0.0/16
    - 172.16.0.0/16
    - 10.0.0.0/8
    allowed:
    - IPProtocol: all

- name: another-vpc
  type: compute.v1.network
  properties: 
    autoCreateSubnetworks: false
- name: not-as-local
  type: compute.v1.subnetwork
  properties:
    network: $(ref.another-vpc.selfLink) 
    ipCidrRange: 192.168.56.0/24
    region: us-central1
    secondaryIpRanges:
      - rangeName: pods
        ipCidrRange: 172.16.0.0/23
      - rangeName: services
        ipCidrRange: 172.16.2.0/23
- name: allow-internal
  type: compute.v1.firewall
  properties:
    network: $(ref.another-vpc.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges:
    - 192.168.0.0/16
    - 172.16.0.0/16
    - 10.0.0.0/8
    allowed:
    - IPProtocol: all

- name: addPeering
  action: gcp-types/compute-v1:compute.networks.addPeering
  properties:
    network: another-vpc
    name: shared-vpc-peering
    autoCreateRoutes: true
  ## MAKE SURE TO REPLACE WITH THE HOST VPC PROJECT ID
    peerNetwork: projects/[shared-vpc-project-id]/global/networks/shared-vpc
  metadata:
    runTimePolicy:
    - CREATE

- name: instance1
  type: instance.jinja
  properties:
    name: bastion
    region: us-central1
    zone: us-central1-c
    networkInterfaces:
    ##UPDATE WITH HOST PROJECT ID
    - hostProject: [host-project-ID]
      network: shared-vpc
      subnetwork: clusters
    tags:
    - bastion
    autoDelete: true
    osLogin: enabled
    metadata:
    - key: block-project-ssh-keys
      value: "true"

- name: cluster1
  type: cluster.jinja
  properties:
    name: standard-cluster-1
    location: us-central1-a
    network: local-vpc
    subnetwork: primary-local

- name: cluster2
  type: cluster.jinja
  properties:
    name: moose
    location: us-central1-c
    network: local-vpc
    subnetwork: primary-local
    vpc-native: true
    private-cluster: true
    hosts:
    - host-name: bastion
      host-cidr: $(ref.bastion.networkInterfaces[0].accessConfigs[0].natIP)/32
    master-cidr: 172.16.64.32/28

- name: cluster3
  type: cluster.jinja
  properties:
    name: hippo
    location: us-central1
    network: local-vpc
    subnetwork: primary-local
    vpc-native: true
    pod-cidr: pods
    service-cidr: services1
    private-cluster: true
    hosts:
    - host-name: bastion
      host-cidr: $(ref.bastion.networkInterfaces[0].accessConfigs[0].natIP)/32
    master-cidr: 172.16.64.0/28
    labels:
    - key: access-type
      value: private
    - key: location-type
      value: regional
    nodePools:
    - name: default
      initialNodeCount: 1

- name: cluster4
  type: cluster.jinja
  properties:
    name: lion
    location: us-central1
    network: local-vpc
    subnetwork: primary-local
    vpc-native: true
    pod-cidr: pods
    service-cidr: services2
    labels:
    - key: access-type
      value: public
    - key: location-type
      value: regional
    nodePools:
    - name: default
      initialNodeCount: 1
      minNodeCount: 3
      maxNodeCount: 9
    - name: big-pods
      initialNodeCount: 1
      machineType: n1-standard-2

- name: cluster5
  type: cluster.jinja
  properties:
    name: narwhal
    location: us-central1-a
    network: another-vpc
    subnetwork: not-as-local
    labels:
    - key: access-type
      value: public
    - key: location-type
      value: zonal
    networkPolicy: true
    httpLB: disabled

- name: cluster6
  type: cluster.jinja
  properties:
    name: zebra
    location: us-central1-a
    network: another-vpc
    subnetwork: not-as-local
    vpc-native: true
    pod-cidr: pods
    service-cidr: services
    labels:
    - key: location-type
      value: zonal
    - key: access-type
      value: public

- name: cluster7
  type: cluster.jinja
  properties:
    name: mongoose
    location: us-central1-a
    network: shared-vpc
    subnetwork: clusters
    vpc-native: true
    pod-cidr: pods
    service-cidr: service1
    private-cluster: true
    master-cidr: 172.16.63.0/28
    httpLB: disabled
    labels:
    - key: access-type
      value: private
    - key: location-type
      value: zonal
    nodePools:
    - name: weird-mammal
      initialNodeCount: 2
      minNodeCount: 1
      maxNodeCount: 4
